<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NBA Notify</title>
    <script defer src="./app.js" type="module"></script>
    <link rel="stylesheet" href="./style.css" />
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico" />
    <link rel="manifest" href="manifest.json" />
  </head>
  <body>
    <div class="cards">
      <article class="information [ card ]">
        <span class="tag">NBA</span>
        <h2 class="title">Never miss the best NBA games</h2>
        <p class="info">
          The following NBA games have been played yesterday and are the most interesting games to watch (based on
          score). Turn off spoilers in the NBA app to watch.
        </p>
        <button class="button">
          <span><a target="_blank" href="https://nba.com">Watch games</a></span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="none">
            <path d="M0 0h24v24H0V0z" fill="none" />
            <path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4v3z" fill="currentColor" />
          </svg>
        </button>
      </article>
      <game-cards></game-cards>
    </div>

    <script>
      const $ = () => document.querySelector.call(this, arguments);
      const $$ = () => document.querySelectorAll.call(this, arguments);
      HTMLElement.prototype.on = (a, b, c) => this.addEventListener(a, b, c);
      HTMLElement.prototype.off = (a, b) => this.removeEventListener(a, b);
      HTMLElement.prototype.$ = (s) => this.querySelector(s);
      HTMLElement.prototype.$ = (s) => this.querySelectorAll(s);
    </script>

    <script>
      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      navigator.serviceWorker
        .register("./sw.js")
        .then((registration) => {
          return registration.pushManager.getSubscription().then(async (subscription) => {
            if (subscription) {
              return subscription;
            }
            const convertedVapidKey = urlBase64ToUint8Array(
              "BKwK22zmIrT9Myoro6H8vuNPIx_fm3B1RnJmzAeUCuPyWa30GFTHG9Iy9UGAWZTlQWA0eoziRIyq2br51uuzcoU"
            );

            return registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: convertedVapidKey,
            });
          });
        })
        .then((subscription) => {
          return fetch("https://nbaapi-ihcuq5swpq-uc.a.run.app/nba/push-register", {
            method: "post",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify({ subscription }),
          });
        });
    </script>
  </body>
</html>
